ifndef NEKRS_WORKING_DIR
$(error "Error, environment variable [NEKRS_WORKING_DIR] is not set")
endif

ifndef NEKRS_NEKINTERFACE_DIR
$(error "Error, environment variable [NEKRS_NEKINTERFACE_DIR] is not set")
endif

## Use the Nek5000 makefile generated by nekconfig in working dir
include ${NEKRS_WORKING_DIR}/makefile

left:= (
right:= )
USR_LFLAGS_:=$(shell echo $(USR_LFLAGS) | sed -E "s@-L$(left)[^ ]+$(right)@-Wl,-rpath,\1 -L\1@g")

NI_LDFLAGS = $(LDFLAGS) -Wl,-rpath,. -L$(OBJDIR) -lnek5000 -ldl $(USR_LFLAGS_)

$(NEKRS_WORKING_DIR)/nekInterface.o: $(NEKRS_NEKINTERFACE_DIR)/nekInterface.f $(LIB) 
	$(FC) -c $(FL2) $< -o $@ 

libnekInterface: lib$(CASENAME).so

lib$(CASENAME).so: $(LIB) $(USRF) $(NEKRS_WORKING_DIR)/nekInterface.o
	$(FC) $(FL2) -shared -o lib$(CASENAME).so $(USRF) $(NEKRS_WORKING_DIR)/nekInterface.o $(NI_LDFLAGS)

.PHONY: libnekInterface 
