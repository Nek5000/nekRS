name: CI

on:
  # allows us to run workflows manually
  workflow_dispatch:

  pull_request:
    branches:
      - master
  push:
    branches:
      - master

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  NEKRS_HOME: ${{ github.workspace }}/.local/nekrs
  MPICH_FC: gfortran
  NEKRS_EXAMPLES: ${{ github.workspace }}/.local/nekrs/examples
  OCCA_CUDA_ENABLED: 0
  OCCA_HIP_ENABLED: 0
  OCCA_OPENCL_ENABLED: 0
  NEKRS_OCCA_MODE_DEFAULT: SERIAL
  NEKRS_CI: 1

jobs:

  setup:
    runs-on: ubuntu-latest
    shell: bash
    steps:
      - uses: actions/checkout@v2
      - name: APT Install
        run: |
          sudo apt -y update
          sudo apt install -y mpich libmpich-dev

  build_nekrs:
    runs-on: ubuntu-latest
    shell: bash
    needs: setup
    steps:
      - name: build
        run: |
          ./nrsconfig
          cmake --build build --target install -j 2
      - name: archive_build
        uses: actions/upload-artifact@v2
        with:
          - name: build_dir
            path: ${NEKRS_HOME}

#  ethier:
#    runs-on: ubuntu-latest
#    shell: bash
#    needs: build_nekrs
#    steps:
#      - name: download_build_dir
#        uses: actions@download-artifact@v2
#        with:
#          - name: build_dir
#      - name: warmup
#        run: |
#          cd $NEKRS_EXAMPLES/ethier 
#          ${NEKRS_HOME}/bin/nrspre ethier 1
#      - name: default
#        run: |
#          cd $NEKRS_EXAMPLES/ethier 
#          ${NEKRS_HOME}/bin/nrsmpi ethier 1 1
#      - name: subcycle
#        run: |
#          cd $NEKRS_EXAMPLES/ethier 
#          ${NEKRS_HOME}/bin/nrsmpi ethier 2 2
#
#  mv_cyl:
#    runs-on: ubuntu-latest
#    shell: bash
#    needs: build_nekrs
#    steps:
#      - name: download_build_dir
#        uses: actions@download-artifact@v2
#        with:
#          - name: build_dir
#      - name: warmup
#        run: |
#          cd $NEKRS_EXAMPLES/mv_cyl 
#          ${NEKRS_HOME}/bin/nrspre mv_cyl 1
#      - name: default
#        run: |
#          cd $NEKRS_EXAMPLES/mv_cyl 
#          ${NEKRS_HOME}/bin/nrsmpi mv_cyl 2 1
#      - name: subcycle
#        run: |
#          cd $NEKRS_EXAMPLES/mv_cyl 
#          ${NEKRS_HOME}/bin/nrsmpi mv_cyl 2 2
